datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "cargo prisma"
  output   = "../src/prisma.rs"
}

enum LessonStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum Level {
  A1
  A2
  B1
  B2
  C1
  C2
}

model User {
  id              BigInt       @id
  firstName       String       @db.VarChar(255)
  lastName        String?      @db.VarChar(255)
  username        String?      @unique @db.VarChar(33)
  languageCode    String       @db.VarChar(2)
  allowsWriteToPm Boolean      @default(false)
  photoUrl        String?      @db.VarChar(2048)
  createdAt       DateTime     @default(now())
  userLessons     UserLesson[]
  userStats       UserStats?

  @@index([username])
  @@index([id])
}

model Lesson {
  id          String       @id @default(uuid()) @db.Uuid
  lessonData  Json
  studiedLang String       @db.VarChar(2)
  lessonLang  String       @db.VarChar(2)
  level       Level
  createdAt   DateTime     @default(now())
  userLessons UserLesson[]

  @@index([studiedLang, lessonLang, level])
  @@index([id])
}

model UserLesson {
  id            String       @id @default(uuid()) @db.Uuid
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        BigInt
  lesson        Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId      String       @db.Uuid
  score         Int          @default(0)
  status        LessonStatus @default(PENDING)
  completedAt   DateTime?
  nextAvailable DateTime?

  @@unique([userId, lessonId])
  @@index([id])
  @@index([nextAvailable])
}

model UserStats {
  userId       BigInt @id
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalScore   Int    @default(0)
  totalLessons Int    @default(0)
}
